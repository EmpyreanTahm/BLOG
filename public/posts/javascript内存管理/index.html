<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="utf-8">
  <title>JavaScript：内存管理</title>

  <meta name="author" content="GeeKery">
  <meta name="description" content="  朝闻道 夕死可矣  ">

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">

  <!-- Favicon -->
  <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

  <!-- CSS Plugins -->

<link rel="preconnect" href="https://fonts.gstatic.com">











<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Mulish:wght@500;600;700;800;900&amp;display=swap">




<link rel="stylesheet" href="/css/vendor.min.baf52ea3605b317bff1a5643db187b2f7d588fa8f7f86f8563edd75fe058becd61ff13627cd610439cfd7bdb239855cd89ef10674abb20fe6843b2b2aa589c6b.css" integrity="sha512-uvUuo2BbMXv/GlZD2xh7L31Yj6j3&#43;G&#43;FY&#43;3XX&#43;BYvs1h/xNifNYQQ5z9e9sjmFXNie8QZ0q7IP5oQ7Kyqlicaw==" media="screen">

</head>

<body>

<div class="preloader"></div>

  <div class="header-height-fix"></div>
<header class="header-nav">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <nav class="navbar navbar-expand-lg navbar-light p-0">
          <a class="navbar-brand font-weight-bold mr-0" href="/">

            <img loading="lazy" src="/images/logo.png" alt="GeeKery" height="40px">

          </a>


          <button class="search-toggle d-inline-block d-lg-none ml-auto mr-3" data-toggle="search" aria-label="Search Toggle">
            <i class="las la-search"></i>
          </button>


          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navHeader" aria-controls="navHeader" aria-expanded="false" aria-label="Toggle navigation">
            <i class="d-inline lab la-buromobelexperte"></i>
            <i class="d-none las la-times"></i>
          </button>

          <div class="collapse navbar-collapse" id="navHeader">
            <ul class="navbar-nav mx-auto">






              <li class="nav-item ">
                <a class="nav-link" href="/">Home</a>
              </li>





              <li class="nav-item ">
                <a class="nav-link" href="/author">Author</a>
              </li>





              <li class="nav-item ">
                <a class="nav-link" href="/categories">Categories</a>
              </li>





              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle d-inline-block " href="#" role="button" data-toggle="dropdown" aria-expanded="false">Archives</a>
                <ul class="dropdown-menu">

                  <li><a class="dropdown-item " href="/categories">Category</a></li>

                </ul>
              </li>





              <li class="nav-item ">
                <a class="nav-link" href="/tags">Tags</a>
              </li>





              <li class="nav-item ">
                <a class="nav-link" href="/about">About</a>
              </li>


            </ul>


            <div class="navbar-right d-none d-lg-inline-block">
              <ul class="social-links list-unstyled list-inline">
                <li class="list-inline-item ml-4 d-none d-lg-inline-block">
                  <button class="search-toggle" data-toggle="search" aria-label="Search Toggle">
                    <i class="las la-search"></i>
                  </button>
                </li>
              </ul>
            </div>

          </div>
        </nav>
      </div>
    </div>
  </div>
</header>


<div class="search-block">
  <div data-toggle="search-close">
    <i class="las la-times text-primary"></i>
  </div>
  <form action="/search">
    <input id="search-query" name="s" type="search" placeholder="输入 &amp; 回车" class="text-center" aria-label="search-query">
  </form>
</div>



  <section class="section-sm pb-2 page-header">
  <div class="container">
    <div class="row">
      <div class="col-8 mx-auto text-center">


        <h3 class="mb-3 text-dark font-weight-bold">JavaScript：内存管理</h3>



        <ul class="list-inline breadcrumb-menu">


        <li class="list-inline-item"><a href="/">Home</a></li>



        <li class="list-inline-item">/ &nbsp; <a href="/postsjavascript%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86">Postsjavascript% e5%86%85% e5% a d%98% e7% a e% a1% e7%90%86</a></li>



        </ul>
      </div>
    </div>
  </div>
</section>






<section class="section-sm">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="text-center mb-5">
          <h3 class="h2 mb-4 post-title">JavaScript：内存管理</h3>
          <ul class="card-meta list-inline">
            <li class="list-inline-item">
              <a href="#!" class="card-meta-author">

                <a href="/" class="card-meta-author">
                  <img loading="lazy" src="/" alt="GeeKery">
                  <span>GeeKery</span>
                </a>

              </a>
            </li>
            <li class="list-inline-item">|</li>
            <li class="list-inline-item">
              <span>19 January 2021</span>
            </li>
          </ul>
        </div>



        <div class="content">
          <p>内存的生命周期包括分配内存、使用内存和释放内存。有些语言（比如 C 语言）必须手动分配和释放内存，JavaScript 的内存分配过程是在做变量声明赋值时自动完成的。变量完成内存分配之后程序才可以使用进行读写。当程序不需要再使用某些变量时，它们占用的内存就会进行释放，腾出空间。</p>
<h2 id="内存溢出">内存溢出</h2>
<p>程序的运行需要内存，只要程序提出要求，操作系统或者运行时（Runtime）就必须供给内存。程序运行过程中申请的内存大于系统能够提供的内存，导致程序无法申请到足够的内存，这就是内存溢出（Out Of Memory）。</p>
<h2 id="内存泄漏">内存泄漏</h2>
<p><strong>不再用到的内存，没有及时释放，就叫做内存泄漏（Memory Leak），内存泄漏与大小无关，并非导致程序卡顿、崩溃才能叫做内存泄漏</strong>。</p>
<p>内存泄漏的堆积，会使内存占用越来越高，轻则影响系统性能，重则导致进程崩溃，尤其是持续运行的服务进程（Daemon）。</p>
<p>在 Chrome 浏览器的 Performance 功能中，使用 Memory 选项可以帮助开发者查看内存占用，如果内存不是趋于平稳，而是一直上升，则可能发生了内存泄漏。在 Performance 功能中，也可以手动进行垃圾回收。</p>
<p>Node.js 提供了 process.memoryUsage 方法，process.memoryUsage 返回一个对象，包含了 Node.js 进程的内存占用信息，该对象包含四个字段，单位是字节。判断内存泄漏，以 heapUsed 字段为准。</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JavaScript" data-lang="JavaScript">console.log(process.memoryUsage())
<span style="color:#999;font-style:italic">// Prints:
</span><span style="color:#999;font-style:italic">// {
</span><span style="color:#999;font-style:italic">//  rss: 4935680,
</span><span style="color:#999;font-style:italic">//  heapTotal: 1826816,
</span><span style="color:#999;font-style:italic">//  heapUsed: 650472,
</span><span style="color:#999;font-style:italic">//  external: 49879,
</span><span style="color:#999;font-style:italic">//  arrayBuffers: 9386
</span><span style="color:#999;font-style:italic">// }
</span></code></pre></div><blockquote>
<ul>
<li>rss（resident set size）：所有内存占用，包括指令区和堆栈。</li>
<li>heapTotal：”堆“占用的内存，包括用到的和没用到的。</li>
<li>heapUsed：用到的堆的部分。</li>
<li>external： V8 引擎内部的 C++ 对象占用的内存。</li>
<li>arrayBuffers：分配给 ArrayBuffers 和 SharedArrayBuffers 的内存，包括所有 Node.js 缓冲区</li>
</ul>
</blockquote>
<h2 id="垃圾回收机制">垃圾回收机制</h2>
<p>释放内存需要判定哪些变量是需要被回收的，对于像 JavaScript 这样的高级语言来说，内存释放过程是由垃圾回收器自动完成的，垃圾回收器会按照固定的时间间隔，周期性地找出不再继续使用的变量，然后释放其占用的内存。JavaScript 用于确定可回收内存的方法主要有两种：引用计数与标记清除。无论哪种回收机制，全局变量的生命周期直至浏览器卸载页面才会结束，也就是说<strong>全局变量不会被当成垃圾回收</strong>。</p>
<h3 id="引用计数">引用计数</h3>
<p>引用计数是被弃用的垃圾回收策略。老版本 IE 的 BOM 和 DOM 对象是使用 C++ 以 COM 对象的形式实现的，COM 的垃圾回收采用的就是引用计数策略。</p>
<p>引用计数的基本原理是，保存每个对象的引用计数，当引用发生增减时对计数进行更新。引用计数的增减，一般发生在变量赋值、对象内容更新、函数结束（局部变量不再被引用）等时间节点。当一个对象的引用计数变为 0 时，则说明它将来不会再被引用，因此可以释放相应的内存空间。</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#6ab825;font-weight:bold">const</span> arr = [<span style="color:#3677a9">1</span>, <span style="color:#3677a9">2</span>, <span style="color:#3677a9">3</span>, <span style="color:#3677a9">4</span>];
console.log(<span style="color:#ed9d13">&#39;hello world&#39;</span>);
</code></pre></div><p>数组 [1, 2, 3, 4] 是一个值，会占用内存。变量 arr 是仅有的对这个值的引用，因此这个数组的被引用次数为 1。尽管后面的代码没有用到 arr 变量，它还是会持续占用内存。</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#6ab825;font-weight:bold">let</span> arr = [<span style="color:#3677a9">1</span>, <span style="color:#3677a9">2</span>, <span style="color:#3677a9">3</span>, <span style="color:#3677a9">4</span>];
console.log(<span style="color:#ed9d13">&#39;hello world&#39;</span>);
arr = <span style="color:#6ab825;font-weight:bold">null</span>;
</code></pre></div><p>上面代码中，将 arr 重置为 null，就解除了对 [1, 2, 3, 4] 的引用，引用次数变成了 0，这部分内存就可以被垃圾回收器释放。</p>
<p>因此，即使有了垃圾回收机制，开发者还是要关注内存占用：那些很占空间的值，一旦不再用到，必须检查是否还存在对它们的引用；如果是的话，就必须手动解除引用。</p>
<p>实现容易是引用计数算法最大的优点，相当具有普遍性。采用引用计数策略，当对象不再被引用的瞬间就会被释放，由于释放操作是针对每个对象个别执行的，因此和其它算法相比，由 GC 而产生的中断时间就比较短。</p>
<p>而引用计数最大的缺点，就是无法释放循环引用的对象。以下 marry 函数执行完毕后，bob 和 alice 两个对象由于互相引用，因此引用计数都为 1，即使后续不会再被使用到，也会持续占用内存，不被释放。当我们不使用它们的时候，需要手动切断引用才能回收内存。</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#6ab825;font-weight:bold">function</span> marry(){
  <span style="color:#6ab825;font-weight:bold">let</span> bob = {};
  <span style="color:#6ab825;font-weight:bold">let</span> alice = {};
  bob.wife = alice; 		<span style="color:#999;font-style:italic">// bob 引用 alice
</span><span style="color:#999;font-style:italic"></span>  alice.husband = bob;	<span style="color:#999;font-style:italic">// alice 引用 bob
</span><span style="color:#999;font-style:italic"></span>
  <span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#ed9d13">&#34;They are married！&#34;</span>;
}

marry();
</code></pre></div><p>另外，引用计数并不适合并行处理。如果多个线程同时对引用计数进行增减的话，引用计数的值就可能会不一致，导致内存错误。为了避免这种情况的发生，对引用计数的操作必须采用独占的方式来进行。如果引用操作频繁发生，每次都要使用加锁等并发控制机制的话，其开销也是不可小觑的。综上所述，引用计数方式的原理和实现虽然简单，但缺点也很多，因此基本上不再被使用。现在，依然采用引用计数方式的语言主要有 Perl 和 Python，但它们为了避免循环引用的问题，都配合使用了其他的 GC 机制。这些语言中，GC 基本上是通过引用计数方式来进行的，但偶尔也会用其他的算法来执行 GC，这样就可以将引用计数方式无法回收的那些对象处理掉。</p>
<h2 id="标记清除">标记清除</h2>
<p>标记清除（Mark and Sweep）是最早开发出的 GC 算法（1960年）。Node.js 的 global 对象和 JavaScript 的 window 对象，被称作”根“，标记清除首先从根开始，将可能被引用的对象用递归的方式进行标记，标记阶段完成时，被标记的对象就被视为”存活“对象。然后将没有标记到的对象作为垃圾进行回收。</p>
<p>零引用的对象肯定是需要被回收的，反过来，需要被回收的对象却不一定是零引用（循环引用）。因此标记清除可以有效解决循环引用的问题。在上面的循环引用示例中，marry 函数调用返回之后，两个对象从全局对象出发无法获取。因此，它们将会被垃圾回收器回收。</p>
<p>从 2012 年起，所有现代浏览器都使用了标记清除垃圾回收算法。所有对 JavaScript 垃圾回收算法的改进都是基于标记清除算法的改进（如 V8 引擎的垃圾回收机制）。</p>

        </div>
      </div>
    </div>

    <div class="single-post-meta">
      <div class="row justify-content-center">
        <div class="col-lg-5 col-md-6 text-center text-md-left">
          <ul class="post-meta-tags list-unstyled list-inline">

            <li class="list-inline-item"><a href="/tags/js%E7%B3%BB%E5%88%97">JS系列</a></li>

          </ul>
        </div>
        <div class="col-lg-5 col-md-6 text-center text-md-right mt-4 mt-md-0">
<ul class="social-links has-bg-color list-unstyled list-inline" style="line-height:0">
  <li class="list-inline-item">

    <a class="resp-sharing-button__link d-block" href="https://facebook.com/sharer/sharer.php?u=%2fposts%2fjavascript%25E5%2586%2585%25E5%25AD%2598%25E7%25AE%25A1%25E7%2590%2586%2f" target="_blank"
      rel="noopener" aria-label="">
      <div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small">
        <div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
          <i class="lab la-facebook-f text-dark"></i>
        </div>
      </div>
    </a>
  </li>

  <li class="list-inline-item">

    <a class="resp-sharing-button__link d-block" href="https://twitter.com/intent/tweet/?text=JavaScript%ef%bc%9a%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86&amp;url=%2fposts%2fjavascript%25E5%2586%2585%25E5%25AD%2598%25E7%25AE%25A1%25E7%2590%2586%2f"
      target="_blank" rel="noopener" aria-label="">
      <div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small">
        <div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
          <i class="lab la-twitter text-dark"></i>
        </div>
      </div>
    </a>
  </li>

  <li class="list-inline-item">

    <a class="resp-sharing-button__link d-block" href="https://plus.google.com/share?url=%2fposts%2fjavascript%25E5%2586%2585%25E5%25AD%2598%25E7%25AE%25A1%25E7%2590%2586%2f" target="_blank"
      rel="noopener" aria-label="">
      <div class="resp-sharing-button resp-sharing-button--google resp-sharing-button--small">
        <div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
          <i class="lab la-google-plus-g text-dark"></i>
        </div>
      </div>
    </a>
  </li>

  <li class="list-inline-item">

    <a class="resp-sharing-button__link d-block" href="mailto:?subject=JavaScript%ef%bc%9a%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86&amp;body=%2fposts%2fjavascript%25E5%2586%2585%25E5%25AD%2598%25E7%25AE%25A1%25E7%2590%2586%2f" target="_self"
      rel="noopener" aria-label="">
      <div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small">
        <div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
          <i class="las la-envelope text-dark"></i>
        </div>
      </div>
    </a>
  </li>

  <li class="list-inline-item">

    <a class="resp-sharing-button__link d-block" href="whatsapp://send?text=JavaScript%ef%bc%9a%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86%20%2fposts%2fjavascript%25E5%2586%2585%25E5%25AD%2598%25E7%25AE%25A1%25E7%2590%2586%2f" target="_blank"
      rel="noopener" aria-label="">
      <div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small">
        <div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
          <i class="lab la-whatsapp text-dark"></i>
        </div>
      </div>
    </a>
  </li>

</ul></div>
      </div>
    </div>

    <div class="single-post-author">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <div class="media d-block d-sm-flex text-center text-sm-left">

            <a href="/"><img loading="lazy" class="img-fluid rounded-circle mr-0 mr-sm-4 mb-4" src="/" alt="GeeKery"></a>
            <div class="media-body">
              <p class="font-primary mb-1">Written By</p>
              <h4><a href="/" class="text-dark font-weight-700">GeeKery</a></h4>
              <p class="font-primary"></p>
              <ul class="social-links list-unstyled list-inline ml-0 ml-sm-n2">

              </ul>
            </div>

          </div>
        </div>
      </div>
    </div>

    <div class="single-post-similer">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <div class="row mt-3">
            <div class="col-12">
              <h3 class="text-dark font-weight-800 mb-4 pb-2">You May Also Like</h3>
            </div>


            <div class="col-md-6">
              <article class="card post-card">

  <div class="card-body">
    <ul class="card-meta list-inline mb-2">
      <li class="list-inline-item mb-2">

        <a href="/" class="card-meta-author">

          <img loading="lazy" src="https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?s=150&pg&d=identicon">

          <span>GeeKery</span>
        </a>

      </li>
      <li class="list-inline-item mb-2">
        <span>18 Jan, 2021</span>
      </li>
      <li class="list-inline-item mb-2">
        <ul class="card-meta-tag list-inline">

          <li class="list-inline-item"><a href="/tags/js%E7%B3%BB%E5%88%97">JS系列</a></li>

        </ul>
      </li>
    </ul>
    <h3 class="mb-3">
      <a class="post-title" href="/posts/javascript%E4%BD%9C%E7%94%A8%E5%9F%9F%E5%92%8C%E9%97%AD%E5%8C%85/">JavaScript：作用域和闭包</a>
    </h3>
    <p>词法作用域 作用域是一套规则，这套规则用来管理引擎如何在当前的作用域以及嵌套的子作用域中根据标识符名称进行变量查找。作用域共有两种主要的工作模型。第一种是最为普遍的，被大多数编程语言所采用的词法作用域，另外一种叫做动态作用域，仍有一些编程语言在使用（比如 Bash 脚本、Perl 中的一些模式 …</p>


  </div>
</article>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</section>




  <footer class="section-sm">
  <div class="container">
    <div class="row justify-content-center align-items-center">
      <div class="col-lg-5">



      </div>
      <div class="col-lg-12 text-center mt-5">
        <ul class="list-inline footer-menu mb-4">

        </ul>
        <ul class="social-links icon-box list-unstyled list-inline font-weight-500 mb-3">

          <li class="list-inline-item text-center"><a href="https://www.linkedin.com/in/jayden-deng-3654b1176" aria-label="social-icon">
            <i class="lab lab la-linkedin-in"></i>
          </a></li>

          <li class="list-inline-item text-center"><a href="mailto:mailto:dqy676081195@gmail.com" aria-label="social-icon">
            <i class="lab las la-at"></i>
          </a></li>

          <li class="list-inline-item text-center"><a href="https://github.com/GeeKeryK" aria-label="social-icon">
            <i class="lab lab la-github"></i>
          </a></li>

        </ul>

        <p class="mb-0 font-weight-500 copyright-text content">Copyright © 2021 GeeKery</p>

      </div>
    </div>
  </div>
</footer>






























<script data-turbolinks-suppress-warning src="/js/vendor.min.145a21dc1d3b6180ba4053b597f77d01206a5207dbc280de83d4151958109b94fad45e42ce423c4c4cf0cef270a67279b4db5d19f05e3eee33b3838de0028318.js" integrity="sha512-FFoh3B07YYC6QFO1l/d9ASBqUgfbwoDeg9QVGVgQm5T61F5CzkI8TEzwzvJwpnJ5tNtdGfBePu4zs4ON4AKDGA=="></script>



</body>

</html>
